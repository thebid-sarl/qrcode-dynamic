<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirection...</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      background: #ffffff;
    }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      font-family: monospace;
      font-size: 12px;
    }
    .loader {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4f46e5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-page {
      text-align: center;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .error-page h2 {
      color: #dc2626;
    }
    .success {
      color: #059669;
      font-weight: bold;
    }
    .error {
      color: #dc2626;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="error-page">
    <h2 style="display: none;" id="debugTitle">üîç Debug Mode - QR Code Redirect</h2>
    <h2 style="display: none;" id="loadingTitle">üîÑ Redirection...</h2>
    
    <div class="debug-info" id="debugInfo" style="display: none;">
      <div>Initialisation...</div>
    </div>
    
    <div class="loader" id="loader"></div>
    
    <div id="result"></div>
  </div>

  <script>
    // Mode debug activ√© si ?debug=true
    const DEBUG_MODE = window.location.search.includes('debug=true');
    const urlParams = new URLSearchParams(window.location.search);
    const redirectId = urlParams.get('id');

    function log(message, type = 'info') {
      if (!DEBUG_MODE) return;
      const debugDiv = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#dc2626' : type === 'success' ? '#059669' : '#000';
      debugDiv.innerHTML += `<div style="color:${color}">[${timestamp}] ${message}</div>`;
      console.log(`[REDIRECT DEBUG] ${message}`);
    }

    function initInterface() {
      if (DEBUG_MODE) {
        document.getElementById('debugTitle').style.display = 'block';
        document.getElementById('debugInfo').style.display = 'block';
      } else {
        document.getElementById('loadingTitle').style.display = 'block';
        document.body.style.display = 'flex';
        document.body.style.alignItems = 'center';
        document.body.style.justifyContent = 'center';
        document.body.style.minHeight = '100vh';
        document.body.style.padding = '0';
      }
    }

    function showResult(message, isSuccess = false) {
      document.getElementById('loader').style.display = 'none';
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `<div class="${isSuccess ? 'success' : 'error'}">${message}</div>`;
    }

    function performRedirect(url) {
      log(`üöÄ Redirection vers: ${url}`, 'success');
      if (DEBUG_MODE) {
        showResult(`Redirection vers: ${url}`, true);
        setTimeout(() => {
          const link = document.createElement('a');
          link.href = url;
          link.textContent = `Cliquer ici pour aller sur ${url}`;
          link.style.display = 'block';
          link.style.marginTop = '20px';
          link.style.color = '#4f46e5';
          document.getElementById('result').appendChild(link);
        }, 1000);
      } else {
        window.location.replace(url);
      }
    }

    // R√©solution de la redirection
    async function resolveRedirect() {
      log('üîç D√©but de la r√©solution');
      log(`üìç URL actuelle: ${window.location.href}`);
      log(`üÜî ID extrait: ${redirectId || 'AUCUN'}`);

      if (!redirectId) {
        log('‚ùå Aucun ID trouv√©', 'error');
        showResult('‚ùå ID manquant dans l‚ÄôURL');
        return;
      }

      try {
        // 1. V√©rifier localStorage
        const localRedirects = JSON.parse(localStorage.getItem('qrRedirects') || '{}');
        if (localRedirects[redirectId]) {
          log(`‚úÖ Trouv√© dans localStorage: ${localRedirects[redirectId]}`, 'success');
          performRedirect(localRedirects[redirectId]);
          return;
        }

        // 2. V√©rifier JSON (redirects.json seulement)
        log('üîç Tentative de chargement de redirects.json...');
        const response = await fetch('redirects.json');
        log(`üì° Statut: ${response.status}`);
        if (response.ok) {
          const jsonRedirects = await response.json();
          log(`üìÑ Contenu: ${JSON.stringify(jsonRedirects)}`);
          if (jsonRedirects[redirectId]) {
            log(`‚úÖ Trouv√© dans JSON: ${jsonRedirects[redirectId]}`, 'success');
            performRedirect(jsonRedirects[redirectId]);
            return;
          } else {
            log(`‚ùå ID '${redirectId}' non trouv√© dans le JSON`, 'error');
          }
        } else {
          log(`‚ùå Impossible de charger le JSON: ${response.status}`, 'error');
        }

        // 3. Rien trouv√©
        log(`‚ùå ID '${redirectId}' non trouv√©`, 'error');
        showResult(`‚ùå Lien '${redirectId}' non trouv√©`);

      } catch (error) {
        log(`‚ùå Erreur globale: ${error.message}`, 'error');
        showResult(`‚ùå Erreur technique: ${error.message}`);
      }
    }

    initInterface();
    resolveRedirect();
  </script>
</body>
</html>
